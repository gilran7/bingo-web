<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Bingo Automático</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>BINGO AUTOMÁTICO PROFESIONAL</h1>

    <div class="juego-container">

        <!-- Columna 1: Panel de Control Izquierdo (AHORA SOLO EL TABLERO) -->
        <div class="panel-izquierdo">
            <!-- CORRECCIÓN: Se han añadido los contenedores que el script necesita para dibujar la tabla -->
            <div id="tabla-maestra">
                <div id="contenedor-columnas-letras"></div>
                <div id="contenedor-numeros-maestros"></div>
            </div>
            <button id="boton-anadir-carton">Añadir Cartón</button>
            <button id="boton-verificar-duplicados">Verificar Duplicados</button>
            <button id="boton-borrar-cartones">Borrar Todos los Cartones</button>
            <!-- ====================================================== -->
            <!-- BOTÓN PARA GUARDAR EN LA BASE DE DATOS -->
            <button id="guardar-cartones-almacen" style="background-color: #28a745; color: white; width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                Guardar Cartones en Almacén
            </button>
            <!-- ====================================================== -->
        </div>

        <!-- Columna 2: Panel de Control y Cartones -->
        <div class="panel-derecho">
            <div class="seccion-superior-fija">
                <div class="controles-superiores">
                    <div class="displays-superiores-container">
                        <div id="visualizador-patron">
                            <h4>PATRÓN EN JUEGO</h4>
                            <img id="imagen-patron" src="imagenes/patron_lnormal.png" alt="Patrón de Bingo">
                        </div>
                        <div class="marcador-historial-container">
                            <div class="marcador">
                                <p>Último número cantado:</p>
                                <div id="numero-cantado">--</div>
                            </div>
                            <div id="panel-historial">
                                <h3>Últimos 5 Números</h3>
                                <div id="lista-historial"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="control-modo">
                        <button id="boton-modo">Cambiar a Modo Manual</button>
                        <span id="display-modo">Modo: Automático</span>
                    </div>
                    <div class="controles-principales">
                        <button id="boton-cantar">Cantar Número</button>
                        <button id="boton-retroceder" disabled>Retroceder</button>
                        <button id="boton-nueva-ronda">NUEVA RONDA</button>
                        <button id="boton-mostrar-ganadores" disabled>Mostrar Ganadores</button>
                    </div>
                </div>
                <hr>
                <div class="controles-cartones">
                     <select id="select-patron" name="patron" title="Seleccionar Patrón">
                        <option value="lnormal">L Normal</option>
                        <option value="linvertida">L Invertida</option>
                        <option value="4esquinas">4 Esquinas</option>
                        <option value="cruzpequeña">Cruz Pequeña</option>
                        <option value="cruzgrande">Cruz Grande</option>
                        <option value="x">Diagonal X</option>
                        <option value="e">Forma E</option>
                        <option value="t">Forma T</option>
                        <option value="fila">Fila Completa</option>
                        <option value="columna">Columna</option>
                        <option value="bordecarton">Borde Cartón</option>
                        <option value="cartonlleno">Cartón Lleno</option>
                    </select>
                </div>
            </div>
            <div id="zona-de-cartones"></div>
        </div>
    </div>

    <!-- Modal (OJO: Se ha eliminado el botón "Siguiente Ganador" que ya no se usa) -->
    <div id="modal-ganador-backdrop" class="hidden">
        <div id="modal-ganador-content">
            <button id="modal-close-button">&times;</button>
            <div id="modal-carton-container"></div>
            <!-- El botón "Siguiente Ganador" ha sido eliminado del modal,
                 ya que la nueva lógica está en el botón principal "Mostrar Ganadores" -->
        </div>
    </div>

    <script src="script.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const saveButton = document.getElementById('guardar-cartones-almacen');

            if (saveButton) {
                saveButton.addEventListener('click', async () => {
                    console.log("Botón de guardar presionado. Recolectando datos...");
                    const cardsData = [];
                    const cardElements = document.querySelectorAll('.card'); 

                    cardElements.forEach((cardElement, index) => {
                        const numbers = Array.from(cardElement.querySelectorAll('td'))
                                           .map(td => parseInt(td.innerText, 10))
                                           .filter(num => !isNaN(num));
                        
                        if(numbers.length > 0) {
                            cardsData.push({ id: index + 1, numbers: numbers });
                        }
                    });
                    
                    console.log(`Se recolectaron ${cardsData.length} cartones válidos.`);

                    if (cardsData.length === 0) {
                        alert('No se encontraron cartones válidos en la página para guardar.');
                        return;
                    }

                    alert('Guardando todos los cartones en el servidor... Por favor, espera un momento.');

                    try {
                        // ======================================================
                        // INICIO DE LA CORRECCIÓN DE PRUEBA
                        // Llamamos a la función por su ruta completa y real.
                        // ======================================================
                        const response = await fetch('/.netlify/functions/save-cards', {
                        // ======================================================
                        // FIN DE LA CORRECCIÓN DE PRUEBA
                        // ======================================================
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(cardsData),
                        });

                        // Si la respuesta no es JSON, la leemos como texto para ver qué es
                        if (!response.headers.get("content-type")?.includes("application/json")) {
                            const textError = await response.text();
                            throw new Error(`El servidor no respondió con JSON. Respuesta: ${textError}`);
                        }

                        const result = await response.json();

                        if (response.ok) {
                            alert('¡ÉXITO! Los cartones se han guardado correctamente en el almacén.');
                        } else {
                            throw new Error(result.error || 'Ocurrió un error desconocido en el servidor.');
                        }
                    } catch (error) {
                        console.error('Error al guardar los cartones:', error);
                        alert(`Hubo un error al guardar los cartones. Por favor, intenta de nuevo.\nDetalles: ${error.message}`);
                    }
                });
            } else {
                console.error("No se encontró el botón con id 'guardar-cartones-almacen'");
            }
        });
    </script>

</body>
</html>