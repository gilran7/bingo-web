<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Bingo Automático Profesional</title>
    <!-- Vinculamos tu hoja de estilos principal -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>BINGO AUTOMÁTICO PROFESIONAL</h1>
    <hr>

    <div class="juego-container">
        <!-- ============================================= -->
        <!-- PANEL IZQUIERDO (TABLA MAESTRA Y CONTROLES)   -->
        <!-- ============================================= -->
        <div class="panel-izquierdo">
            <div id="tabla-maestra">
                <div id="contenedor-columnas-letras"></div>
                <div id="contenedor-numeros-maestros"></div>
            </div>
            <div class="controles-cartones">
                <button id="boton-anadir-carton">Añadir Cartón</button>
                <button id="boton-verificar-duplicados">Verificar Duplicados</button>
                <button id="boton-borrar-cartones">Borrar Todos los Cartones</button>
                <button id="guardar-cartones-almacen" style="background-color: #28a745; color: white; width: 100%;">
                    Guardar Cartones en Almacén
                </button>
            </div>
        </div>

        <!-- ============================================= -->
        <!-- PANEL DERECHO (JUEGO Y CARTONES)              -->
        <!-- ============================================= -->
        <div class="panel-derecho">
            <div class="seccion-superior-fija">
                <div class="displays-superiores-container">
                    <div id="visualizador-patron">
                        <h4>PATRÓN EN JUEGO</h4>
                        <img id="imagen-patron" src="imagenes/patron_lnormal.png" alt="Patrón L Normal">
                    </div>
                    <div class="marcador">
                        <p>Último número cantado:</p>
                        <div id="numero-cantado">--</div>
                    </div>
                    <div id="panel-historial">
                        <h3>Últimos 5</h3>
                        <div id="lista-historial"></div>
                    </div>
                </div>
                
                <div class="controles-superiores">
                     <div class="controles-principales">
                        <button id="boton-modo">Cambiar a Modo Manual</button>
                        <span id="display-modo">Modo: Automatico</span>
                        <button id="boton-cantar">Cantar Número</button>
                        <button id="boton-retroceder" disabled>Retroceder</button>
                        <button id="boton-nueva-ronda">NUEVA RONDA</button>
                        <button id="boton-mostrar-ganadores" disabled>Mostrar Ganadores</button>
                    </div>
                    <div id="panel-patrones">
                        <select id="select-patron">
                            <option value="lnormal">L Normal</option>
                            <option value="cartonlleno">Cartón Lleno</option>
                            <option value="fila">Fila</option>
                            <option value="columna">Columna</option>
                            <option value="linvertida">L Invertida</option>
                            <option value="e">Letra E</option>
                            <option value="x">Letra X</option>
                            <option value="4esquinas">4 Esquinas</option>
                            <option value="cruzpequeña">Cruz Pequeña</option>
                            <option value="cruzgrande">Cruz Grande</option>
                            <option value="t">Letra T</option>
                            <option value="bordecarton">Borde del Cartón</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="zona-de-cartones">
                <!-- Los cartones generados por script.js aparecerán aquí -->
            </div>
        </div>
    </div>

    <!-- MODAL PARA MOSTRAR GANADORES (oculto por defecto) -->
    <div id="modal-ganador-backdrop" class="hidden">
        <div id="modal-ganador-content">
            <button id="modal-close-button">&times;</button>
            <h2>Cartón Ganador</h2>
            <div id="modal-carton-container"></div>
        </div>
    </div>

    <!-- Tus scripts no necesitan cambios -->
    <script src="script.js"></script>

    <!-- Script de guardado (el que corregimos en el paso anterior) -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const saveButton = document.getElementById('guardar-cartones-almacen');
        if (saveButton) {
            saveButton.addEventListener('click', async () => {
                if (typeof cartonesEnJuego === 'undefined' || cartonesEnJuego.length === 0) {
                    alert("No hay cartones generados para guardar. Por favor, añade al menos un cartón.");
                    return;
                }
                const cardsData = cartonesEnJuego.map(carton => ({
                    id: carton.id,
                    numbers: carton.matriz
                }));

                saveButton.disabled = true;
                saveButton.textContent = 'Guardando...';
                
                try {
                    const response = await fetch('/.netlify/functions/save-cards', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cardsData),
                    });
                    const result = await response.json();
                    if (!response.ok) {
                        throw new Error(result.details || result.error || 'Error desconocido del servidor.');
                    }
                    alert('¡ÉXITO! ' + result.message);
                } catch (error) {
                    console.error('Error detallado al guardar:', error);
                    alert(`Hubo un error al guardar los cartones.\nError: ${error.message}`);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = 'Guardar Cartones en Almacén';
                }
            });
        }
    });
    </script>
    <!-- FORMULARIO FANTASMA PARA LA BASE DE DATOS DE CARTONES -->
<form name="cartones-disponibles" netlify netlify-honeypot="bot-field" hidden>
  <input type="text" name="id" />
  <input type="text" name="numeros" />
  <input type="text" name="status" />
</form>
</body>
</html>